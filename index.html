<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuerdoso</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --bg: #1e1b4b;
            --card-bg: #312e81;
            --text: #e0e7ff;
            --danger: #ef4444;
            --success: #22c55e;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: rgba(255, 255, 255, 0.05);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }

        h1, h2, h3 { text-align: center; margin-top: 0; }
        .hidden { display: none !important; }
        
        /* Loading Overlay */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex; 
            justify-content: center; align-items: center; z-index: 999;
        }

        input, button {
            padding: 10px; border-radius: 6px; border: none; font-size: 1rem; margin: 5px;
        }
        input {
            background: rgba(0, 0, 0, 0.3); color: white; border: 1px solid #4f46e5; width: calc(100% - 22px);
        }
        button {
            cursor: pointer; background-color: var(--primary); color: white; font-weight: bold;
        }
        button:hover { background-color: var(--primary-dark); }
        .btn-danger { background-color: var(--danger); }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-success { background-color: var(--success); }
        .btn-success:hover { background-color: #16a34a; }
        .full-width { width: 100%; margin: 10px 0; }

        .card-display {
            background-color: var(--card-bg); padding: 15px; margin-bottom: 15px;
            border-radius: 8px; border: 1px solid #4338ca;
            display: flex; justify-content: space-between; align-items: center;
        }
        .card-info { flex-grow: 1; }
        .card-title { font-size: 1.1rem; font-weight: bold; display: block; margin-bottom: 5px;}
        .card-desc { font-size: 0.9rem; color: #a5b4fc; }

        /* Estilos para las tarjetas durante el juego */
        .playing-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        .playing-card-item {
            background-color: var(--card-bg);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #4338ca;
            text-align: center;
            font-size: 0.9rem;
        }

        .timer-display {
            font-size: 5rem; text-align: center; font-weight: bold;
            font-variant-numeric: tabular-nums; margin: 20px 0; color: var(--primary);
        }

        .reveal-card {
            background-color: var(--card-bg); padding: 20px; border-radius: 10px; margin-bottom: 20px;
        }
        .answer-list {
            list-style: none; padding: 0; display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;
        }
        .answer-item { background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px; text-align: center; }
        
        .score-row {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.05); padding: 10px; margin-bottom: 5px; border-radius: 5px;
        }
        .score-input { width: 80px; text-align: center; }
        
        .leaderboard-item {
            display: flex; justify-content: space-between; font-size: 1.2rem;
            padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);
        }
    </style>
</head>
<body>

<!-- Loading Screen -->
<div id="loading-overlay">
    <h2>Cargando tarjetas...</h2>
</div>

<div class="container hidden" id="main-app">
    <!-- VISTA 1: MENU -->
    <div id="view-menu">
        <h1>Recuerdoso</h1>
        <div style="margin-bottom: 20px;">
            <label>Tiempo por ronda (segundos):</label>
            <input type="number" id="roundTime" value="60">
        </div>
        <div style="margin-bottom: 20px;">
            <label>Cantidad de rondas:</label>
            <input type="number" id="totalRounds" value="3">
        </div>
        <div style="margin-bottom: 20px;">
            <label>Cantidad de jugadores:</label>
            <input type="number" id="playerCount" value="2" min="1" max="10" onchange="generatePlayerInputs()">
        </div>
        <div id="player-names-container"></div>
        <button class="full-width btn-success" onclick="startGame()">Comenzar Partida</button>
    </div>

    <!-- VISTA 2: SETUP -->
    <div id="view-setup" class="hidden">
        <h2>Ronda <span id="currentRoundDisplay">1</span></h2>
        <p style="text-align: center; color: #a5b4fc;">Revisen las tarjetas. Voten para cambiar.</p>
        <div id="cards-container"></div>
        <div style="margin-top: 30px;">
            <button class="full-width btn-success" onclick="startTimerPhase()">¡Empezar Tiempo!</button>
            <button class="full-width btn-danger" onclick="endGame()" style="margin-top: 15px;">Terminar Partida Ahora</button>
        </div>
    </div>

    <!-- VISTA 3: PLAYING -->
    <div id="view-playing" class="hidden">
        <h2>¡Escriban sus respuestas!</h2>
        <!-- Contenedor nuevo para las tarjetas -->
        <div id="playing-cards-container" class="playing-cards-grid"></div>
        
        <div class="timer-display" id="timer">00:00</div>
        <div style="text-align: center;">
            <button class="btn-danger" style="font-size: 1.5rem; padding: 20px;" onclick="stopTimer()">¡STOP! Terminé</button>
            <p style="margin-top: 10px; font-size: 0.9rem; color: #ef4444;">Si parás y tenés errores, sumás la mitad.</p>
        </div>
    </div>

    <!-- VISTA 4: REVEAL -->
    <div id="view-reveal" class="hidden">
        <h2>Corrección</h2>
        <div id="reveal-container"></div>
        <div style="display: flex; gap: 10px;">
            <button class="full-width" onclick="nextRevealCard()">Siguiente Tarjeta</button>
            <button id="btn-goto-scoring" class="full-width btn-success hidden" onclick="goToScoring()">Ir a Puntajes</button>
        </div>
    </div>

    <!-- VISTA 5: SCORING -->
    <div id="view-scoring" class="hidden">
        <h2>Puntos de la Ronda</h2>
        <div id="scoring-inputs"></div>
        <button class="full-width btn-success" onclick="finishRound()">Finalizar Ronda</button>
    </div>

    <!-- VISTA 6: RESULTS -->
    <div id="view-results" class="hidden">
        <h1>Resultados Finales</h1>
        <div id="leaderboard"></div>
        <button class="full-width" onclick="location.reload()">Jugar de nuevo</button>
    </div>
</div>

<script>
    let cardsDatabase = []; 

    let state = {
        players: [],
        settings: { time: 60, rounds: 3, playerCount: 2 },
        currentRound: 1,
        activeCards: [],
        availableCards: [],
        revealIndex: 0,
        timerInterval: null
    };

    // --- CARGA DE DATOS ASINCRONA ---
    async function init() {
        try {
            const response = await fetch('tarjetas.json');
            if (!response.ok) throw new Error("No se pudo cargar el archivo json");
            
            cardsDatabase = await response.json();
            
            state.availableCards = [...cardsDatabase];
            generatePlayerInputs();
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');

        } catch (error) {
            alert("Error cargando tarjetas.json: " + error.message);
            console.error(error);
        }
    }

    // --- FUNCIONES DEL JUEGO ---
    function generatePlayerInputs() {
        const count = document.getElementById('playerCount').value;
        const container = document.getElementById('player-names-container');
        container.innerHTML = '';
        for (let i = 0; i < count; i++) {
            const input = document.createElement('input');
            input.placeholder = `Nombre Jugador ${i + 1}`;
            input.id = `player-name-${i}`;
            input.value = `Jugador ${i + 1}`;
            container.appendChild(input);
        }
    }

    function showView(viewId) {
        ['view-menu', 'view-setup', 'view-playing', 'view-reveal', 'view-scoring', 'view-results'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        document.getElementById(viewId).classList.remove('hidden');
    }

    function startGame() {
        state.settings.time = parseInt(document.getElementById('roundTime').value);
        state.settings.rounds = parseInt(document.getElementById('totalRounds').value);
        state.settings.playerCount = parseInt(document.getElementById('playerCount').value);
        state.players = [];
        for (let i = 0; i < state.settings.playerCount; i++) {
            state.players.push({
                name: document.getElementById(`player-name-${i}`).value,
                totalScore: 0
            });
        }
        setupRound();
    }

    function setupRound() {
        document.getElementById('currentRoundDisplay').innerText = `${state.currentRound} / ${state.settings.rounds}`;
        state.activeCards = [];
        if (state.availableCards.length < state.settings.playerCount) state.availableCards = [...cardsDatabase];
        for (let i = 0; i < state.settings.playerCount; i++) selectRandomCard();
        renderCardsSetup();
        showView('view-setup');
    }

    function selectRandomCard() {
        if (state.availableCards.length === 0) return;
        const randomIndex = Math.floor(Math.random() * state.availableCards.length);
        state.activeCards.push(state.availableCards.splice(randomIndex, 1)[0]);
    }

    function swapCard(index) {
        if (state.availableCards.length === 0) return alert("No quedan más tarjetas.");
        const randomIndex = Math.floor(Math.random() * state.availableCards.length);
        state.activeCards[index] = state.availableCards.splice(randomIndex, 1)[0];
        renderCardsSetup();
    }

    function renderCardsSetup() {
        const container = document.getElementById('cards-container');
        container.innerHTML = '';
        state.activeCards.forEach((card, index) => {
            const div = document.createElement('div');
            div.className = 'card-display';
            div.innerHTML = `
                <div class="card-info"><span class="card-title">${card.category}</span><span class="card-desc">Cantidad: ${card.count}</span></div>
                <button class="btn-danger" onclick="swapCard(${index})">Vetar/Cambiar</button>
            `;
            container.appendChild(div);
        });
    }

    function startTimerPhase() {
        showView('view-playing');
        
        // Renderizar las tarjetas en modo lectura
        const container = document.getElementById('playing-cards-container');
        container.innerHTML = '';
        state.activeCards.forEach(card => {
            const div = document.createElement('div');
            div.className = 'playing-card-item';
            div.innerHTML = `
                <span style="display:block; font-weight:bold; margin-bottom:5px;">${card.category}</span>
                <span style="color: #a5b4fc;">(${card.count})</span>
            `;
            container.appendChild(div);
        });

        let time = state.settings.time;
        const display = document.getElementById('timer');
        display.innerText = formatTime(time);
        display.style.color = "var(--primary)";
        state.timerInterval = setInterval(() => {
            time--;
            display.innerText = formatTime(time);
            if (time <= 10) display.style.color = "#ef4444";
            if (time <= 0) stopTimer();
        }, 1000);
    }
    
    function formatTime(s) { return `${Math.floor(s / 60).toString().padStart(2, '0')}:${(s % 60).toString().padStart(2, '0')}`; }
    function stopTimer() { clearInterval(state.timerInterval); startRevealPhase(); }

    function startRevealPhase() {
        state.revealIndex = 0; showRevealCard(); showView('view-reveal');
    }

    function showRevealCard() {
        const container = document.getElementById('reveal-container');
        const btnNext = document.querySelector('#view-reveal button:first-of-type');
        const btnScore = document.getElementById('btn-goto-scoring');
        if (state.revealIndex >= state.activeCards.length) return;
        const card = state.activeCards[state.revealIndex];
        container.innerHTML = `
            <div class="reveal-card"><h3>${card.category} (${card.count})</h3>
            <ul class="answer-list">${card.answers.map(ans => `<li class="answer-item">${ans}</li>`).join('')}</ul></div>`;
        if (state.revealIndex === state.activeCards.length - 1) {
            btnNext.classList.add('hidden'); btnScore.classList.remove('hidden');
        } else {
            btnNext.classList.remove('hidden'); btnScore.classList.add('hidden');
        }
    }

    function nextRevealCard() { state.revealIndex++; showRevealCard(); }

    function goToScoring() {
        const container = document.getElementById('scoring-inputs');
        container.innerHTML = '';
        state.players.forEach((player, index) => {
            const div = document.createElement('div');
            div.className = 'score-row';
            div.innerHTML = `<span>${player.name}</span><input type="number" id="score-input-${index}" class="score-input" value="0">`;
            container.appendChild(div);
        });
        showView('view-scoring');
    }

    function finishRound() {
        state.players.forEach((player, index) => {
            player.totalScore += parseInt(document.getElementById(`score-input-${index}`).value) || 0;
        });
        if (state.currentRound >= state.settings.rounds) endGame();
        else { state.currentRound++; setupRound(); }
    }

    function endGame() {
        if (state.timerInterval) clearInterval(state.timerInterval);
        const leaderboard = document.getElementById('leaderboard');
        leaderboard.innerHTML = '';
        [...state.players].sort((a, b) => b.totalScore - a.totalScore).forEach(player => {
            const div = document.createElement('div');
            div.className = 'leaderboard-item';
            div.innerHTML = `<span>${player.name}</span><span>${player.totalScore} pts</span>`;
            leaderboard.appendChild(div);
        });
        showView('view-results');
    }

    init();
</script>

</body>
</html>
